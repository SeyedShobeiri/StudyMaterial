---
title: "Portfolio"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r}
# Setup chunk
library(tidyverse)
library(highcharter)
library(tidyquant)
library(timetk)
```

```{r}
fluidRow(
  column(2,
  textInput("stock1","Stock 1","SPY")),
  column(2,
  numericInput("w1","Portf. %",20,min=1,max=100))
)

fluidRow(
  column(2,
  textInput("stock2","Stock 2","EFA")),
  column(2,
  numericInput("w2","Portf. %",20,min=1,max=100))
)

fluidRow(
  column(2,
  textInput("stock3","Stock 3","IJS")),
  column(2,
  numericInput("w3","Portf. %",20,min=1,max=100))
)

fluidRow(
  column(2,
  textInput("stock4","Stock 4","EEM")),
  column(2,
  numericInput("w4","Portf. %",20,min=1,max=100))
)

fluidRow(
  column(2,
  textInput("stock5","Stock 5","AGG")),
  column(2,
  numericInput("w5","Portf. %",20,min=1,max=100))
)

fluidRow(
  column(2,
         dateInput("date","Starting Date","2013-01-01",format="yyyy-mm-dd"))
)

fluidRow(
  column(2,
         selectInput("rebalance","rebal freq",c("Yearly" = "years","Monthly" = "months","Weekly"="weeks
                                                "))
         )
)

actionButton("go","Submit")

portfolio_returns_byhand = eventReactive(input$go, {
  symbols = c(input$stock1,input$stock2,input$stock3,input$stock4,input$stock5)
  prices = getSymbols(symbols,src = 'yahoo',from = input$date,auto.assign = TRUE,warnings = FALSE) %>%
    map(~Ad(get(.))) %>% reduce(merge) %>% `colnames<-`(symbols)
  
  w = c(input$w1/100,input$w2/100,input$w3/100,input$w4/100,input$w5/100)
  
  asset_returns_long = prices %>% to.monthly(indexAt = "last",OHLC=FALSE) %>% tk_tbl(preserve_index = TRUE,rename_index = "date") %>% gather(asset,returns,-date) %>% group_by(asset) %>% mutate(returns = (log(returns) - log(lag(returns))))
  
  portfolio_returns_byhand =  asset_returns_long %>% tq_portfolio(assets_col = asset,returns_col = returns,weights = w,col_rename = "returns")

  })

renderPlot({
portfolio_returns_byhand() %>% ggplot(aes(x=returns)) + geom_histogram(alpha = 0.25,binwidth = 0.01,fill = "cornflowerblue") + geom_density(size = 1,color = "red")
},width = 500,height = 500)


```




































