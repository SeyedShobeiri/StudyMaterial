---
title: "Returns Distribution"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: embed
    vertical_layout: fill
---

```{r setup, message = FALSE}
library(tidyverse)
library(tidyquant)
library(scales)
library(highcharter)
library(tidyquant)
library(timetk)
library(shiny)
library(PerformanceAnalytics)
library(shinydashboard)
library(flexdashboard)
```

Sidebar {.sidebar}
===================================

```{r}
fluidRow(
  column(6,
         textInput("stock1","Stock 1","SPY")),
  column(5,
         numericInput("w1","Portf. %",20,min = 1, max= 100))
)

fluidRow(
  column(6,
  textInput("stock2", "Stock 2", "EFA")),
  column(5,
  numericInput("w2", "Portf. %", 20, min = 1, max = 100))
)

fluidRow(
  column(6,
  textInput("stock3", "Stock 3", "IJS")),
  column(5,
  numericInput("w3", "Portf. %", 20, min = 1, max = 100))
)

fluidRow(
  column(6,
  textInput("stock4", "Stock 4", "EEM")),
  column(5,
  numericInput("w4", "Portf. %", 20, min = 1, max = 100))
)

fluidRow(
  column(6,
  textInput("stock5", "Stock 5", "AGG")),
  column(5,
  numericInput("w5", "Portf. %", 20, min = 1, max = 100))
)

fluidRow(
  column(7,
         dateInput("date","Starting Date","2010-01-01",format = "yyyy-mm-dd"))
)

fluidRow(
  column(7,
         selectInput("rebalance","rebalance freq",
                     c("Yearly" = "years",
                       "Monthly" = "months",
                       "Weekly" = "weeks"))
  )
)

fluidRow(
  column(5,
         numericInput("window","Window",12,min=3,max=36,step=1))
)

fluidRow(
  column(5,
         numericInput("rfr","Risk Free Rate %",1,min=0,max=10,step=1))
)

actionButton("go","submit")

prices <- eventReactive(input$go, {
  symbols <- c(input$stock1, input$stock2, input$stock3, input$stock4, input$stock5)
  
  prices <- 
    getSymbols(symbols, src = 'yahoo', from = input$date, 
               auto.assign = TRUE, warnings = FALSE) %>% 
    map(~Ad(get(.))) %>% 
    reduce(merge) %>%
    `colnames<-`(symbols)
})

w <- eventReactive(input$go, {
  w = c(input$w1/100,input$w2/100,input$w3/100, input$w4/100, input$w5/100)
})

rfr = eventReactive(input$go,{
  Rf = input$rfr/100
})

window = eventReactive(input$go,{
  window = input$window
})

portfolio_returns_byhand = eventReactive(input$go, {
  
  
  asset_returns_long = prices() %>% to.monthly(indexAt = "last",OHLC = FALSE) %>% tk_tbl(preserve_index = TRUE,
                                                                                       rename_index = "date") %>%
    gather(asset,returns,-date) %>% group_by(asset) %>% mutate(returns = (log(returns)-log(lag(returns))))
  
  portfolio_returns_byhand = asset_returns_long %>% tq_portfolio(assets_col = asset,returns_col = returns,
                                                                 weights = w(),
                                                                 col_rename = "returns")
})

portfolio_returns_xts = eventReactive(input$go,{
  prices = prices()
  w = w()
  
  prices_monthly = to.monthly(prices,indexAt = "last", OHLC = FALSE)
  asset_returns_xts = na.omit(Return.calculate(prices_monthly,method="log"))
  
  portfolio_returns_xts = Return.portfolio(asset_returns_xts,weights = w) %>% `colnames<-`("returns")
  
})


port_rolling_sd_tidy = eventReactive(input$go, {
  prices = prices()
  
  portfolio_returns_tq_rebalanced_monthly = prices %>% to.monthly(indexAt = "last",OHLC = FALSE) %>% 
    tk_tbl(preserve_index = TRUE,rename_index = "date") %>% slice(-1) %>% gather(asset,returns,-date) %>% group_by(asset) %>% mutate(returns = (log(returns) - log(lag(returns)))) %>%
      tq_portfolio(assets_col = asset,returns_col = returns,weights = w(),col_rename = "returns",rebalance_on = "months")
  
  window = input$window
  portfolio_rolling_sd_tidy = portfolio_returns_tq_rebalanced_monthly %>% tq_mutate(mutate_fun = rollapply,width = window,FUN = sd,col_rename = ("rolling_sd")) %>% select(date,rolling_sd) %>% na.omit()
})

rolling_skew_xts <- eventReactive(input$go, {
  
  rolling_skew_xts <- 
    rollapply(portfolio_returns_xts(),
            FUN = skewness,
            width = input$window) %>% 
    na.omit()

})

rolling_kurt_xts <- eventReactive(input$go, {
  rolling_kurt_xts <- 
    rollapply(portfolio_returns_xts(),
            FUN = kurtosis,
            width = input$window) %>% 
    na.omit()

})


portfolio_returns_tq_rebalanced_monthly <- eventReactive(input$go, {
  
  prices <- prices()
  w <- c(input$w1/100, input$w2/100, input$w3/100, input$w4/100, input$w5/100)
  
  asset_returns_long <- 
      prices %>% 
      to.monthly(indexAt = "lastof", OHLC = FALSE) %>% 
      tk_tbl(preserve_index = TRUE, rename_index = "date") %>%
      gather(asset, returns, -date) %>% 
      group_by(asset) %>%  
      mutate(returns = (log(returns) - log(lag(returns))))

  
  portfolio_returns_tq_rebalanced_monthly <- 
  asset_returns_long %>%
  tq_portfolio(assets_col  = asset, 
               returns_col = returns,
               weights     = w,
               col_rename  = "returns",
               rebalance_on = "months")
})

sharpe_xts = eventReactive(input$go,{
  rfr = Rf()
  SharpeRatio(portfolio_returns_xts_rebalanced_monthly,
                         Rf = rfr,
                         FUN = "StdDev") %>% `colnames<-`("sharpe_xts")
})

sharpe_tidyverse_byhand = eventReactive(input$go,{
  rfr = Rf()
  portfolio_returns_dplyr_byhand %>% summarise(sharpe_dplyr = mean(returns-rfr)/sd(returns - rfr))
})

sharpe_tq = eventReactive(input$go, {
  rfr = Rf()
  portfolio_returns_tq_rebalanced_monthly %>% tq_performance(Ra = returns,
                                                             performance_fun = SharpeRatio,
                                                             Rf = rfr,
                                                             FUN = "StdDev") %>% `colnames<-`("sharpe_tq")
})

sharpe_byhand_with_return_columns = eventReactive(input$go,{
  rfr = Rf()
  sharpe_byhand_with_return_columns = portfolio_returns_tq_rebalanced_monthly %>% mutate(ratio = mean(returns-rfr)/sd(returns-rfr)) %>% mutate(returns_below_rfr = 
                                                                                                             if_else(returns < rfr, returns, as.numeric(NA))) %>%
    mutate(returns_above_rfr = if_else(returns>rfr,returns,as.numeric(NA))) %>% mutate_if(is.numeric,funs(round(.,4)))
})

market_returns <- eventReactive(input$go, {
  
    getSymbols("SPY", src = 'yahoo', 
            from = input$date, 
             auto.assign = TRUE, 
             warnings = FALSE) %>% 
    map(~Ad(get(.))) %>% 
    reduce(merge) %>%
    `colnames<-`("SPY") %>% 
    to.monthly(indexAt = "lastof", 
               OHLC = FALSE) %>% 
    Return.calculate(method = "log") %>% 
    na.omit()  
})

market_sharpe <- eventReactive(input$go, {
  
  SharpeRatio(market_returns(),
              Rf = rfr(), 
              FUN = "StdDev")
})

market_rolling_sharpe <- eventReactive(input$go, {
  
  rollapply(market_returns(), 
            window(), 
            function(x) 
            SharpeRatio(x, 
                        Rf = rfr(), 
                        FUN = "StdDev")) %>% 
  na.omit()
})

portfolio_returns <- eventReactive(input$go, {
  
  symbols <- c(input$stock1, input$stock2, input$stock3, input$stock4, input$stock5)
  
  validate(need(input$w1 + input$w2 + input$w3 + input$w4 + input$w5 == 100, 
                "The portfolio weights must sum to 100%!"))
  
  w <- c(input$w1/100, input$w2/100, input$w3/100, input$w4/100, input$w5/100)
  
  getSymbols(symbols, src = 'yahoo', from = input$date, 
             auto.assign = TRUE, warnings = FALSE) %>% 
  map(~Ad(get(.))) %>% 
  reduce(merge) %>%
  `colnames<-`(symbols) %>% 
  to.monthly(indexAt = "lastof", 
             OHLC = FALSE) %>% 
  Return.calculate(method = "log") %>% 
  na.omit() %>% 
  Return.portfolio(weights = w)
  
})


portfolio_rolling_sharpe <- eventReactive(input$go, {

  rollapply(portfolio_returns(),
            window(),
            function(x) SharpeRatio(x, 
                                    Rf = rfr(), 
                                    FUN = "StdDev")) %>% 
  na.omit()
})

portfolio_sharpe <- eventReactive(input$go, {
  
  validate(need(input$w1 + input$w2 + input$w3 + input$w4 + input$w5 == 100, "------"))
  
  SharpeRatio(portfolio_returns(),
              Rf = rfr(), 
              FUN = "StdDev")
  
})





















```


Returns
=====================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------

### Histogram

```{r}
renderPlot({
  portfolio_returns_byhand() %>% ggplot(aes(x=returns)) + geom_histogram(alpha = 0.25,binwidth = 0.01,
                                                                         fill = "cornflowerblue")
})

```

### Density

```{r}
renderPlot({
  portfolio_returns_byhand() %>% 
    ggplot(aes(x=returns)) + 
    geom_density(size = 1,color = "red")
})

```

### Histogram + Density

```{r}
renderPlot({
  portfolio_returns_byhand() %>% 
    ggplot(aes(x=returns)) +
    geom_histogram(alpha = 0.25,binwidth = 0.01,fill = "cornflowerblue") +
    geom_density(geom = "line",size = 1,color = "red")
})


```


Volatility
=========================================

Row {data-height = 500}
----------------------------------------

### rolling vol hc

```{r}
renderHighchart({
  
  port_rolling_sd_xts_hc <- 
    port_rolling_sd_tidy() %>% 
    tk_xts(date_col = date) %>% 
    round(., 4) * 100
  
  highchart(type = "stock") %>% 
    hc_title(text = "Portfolio Rolling Volatility") %>%
    hc_yAxis(title = list(text = "Volatility"),
           labels = list(format = "{value}%"),
           opposite = FALSE) %>% 
    hc_add_series(port_rolling_sd_xts_hc, 
                  name = "Portfolio Vol", 
                  color = "cornflowerblue",
                  id = "Port") %>%
    hc_add_theme(hc_theme_flat()) %>%
    hc_navigator(enabled = FALSE) %>% 
    hc_scrollbar(enabled = FALSE)
})

```


Row {data-height = 500}
------------------------------------------------

### rolling vol ggplot

```{r}
renderPlot({
  port_rolling_sd_tidy() %>% 
    ggplot(aes(x = date)) +
    geom_line(aes(y = rolling_sd), color = "cornflowerblue") + 
    scale_y_continuous(labels = scales::percent) +
    ggtitle("Portfolio Rolling Vol") +
    ylab("volatility") +
    scale_x_date(breaks = pretty_breaks(n = 8)) +
    theme(plot.title = element_text(hjust = 0.5))
})

```


Portfolio Skewness and Kurtosis
==================================================

Row {data-height = 600, .tabset}
--------------------------------------------------

### Rolling Skewness

```{r}
renderHighchart({
  
  highchart(type = "stock") %>%
    hc_title(text = "Rolling Skew") %>%
    hc_add_series(rolling_skew_xts(), name = "rolling skew", color = "cornflowerblue") %>%
    hc_yAxis(title = list(text = "skewness"),
           opposite = FALSE,
           max = 3, 
           min = -3) %>%
  hc_navigator(enabled = FALSE) %>% 
  hc_scrollbar(enabled = FALSE)  %>% 
    hc_exporting(enabled = TRUE)
})

```

### Rolling Kurtosis

```{r}
renderHighchart({
  
  highchart(type = "stock") %>%
    hc_title(text = "Rolling Kurtosis") %>%
    hc_add_series(rolling_kurt_xts(), 
                  name = "rolling kurt", 
                  color = "cornflowerblue") %>%
    hc_yAxis(title = list(text = "kurtosis"),
           opposite = FALSE,
           max = 3, 
           min = -3) %>%
  hc_navigator(enabled = FALSE) %>% 
  hc_scrollbar(enabled = FALSE) %>% 
  hc_exporting(enabled = TRUE)
})

```


Row {.tabset .tabset-fade}
-----------------------------------

### Histogram 

```{r}
renderPlot({

  portfolio_returns_tq_rebalanced_monthly() %>%
  mutate(hist_col_red = 
           ifelse(returns < (mean(returns) - 2*sd(returns)), 
                  returns, NA),
         hist_col_green = 
           ifelse(returns > (mean(returns) + 2*sd(returns)), 
                  returns, NA),
         hist_col_blue = 
           ifelse(returns > (mean(returns) - 2*sd(returns)) &
                  returns < (mean(returns) + 2*sd(returns)),
                  returns, NA)) %>% 
  ggplot() + 
  
  geom_histogram(aes(x = hist_col_red),
               alpha = .7, 
               binwidth = .003, 
               fill = "red", 
               color = "red") +
  
  geom_histogram(aes(x = hist_col_green),
               alpha = .7, 
               binwidth = .003, 
               fill = "green", 
               color = "green") +
  
  geom_histogram(aes(x = hist_col_blue),
               alpha = .7, 
               binwidth = .003, 
               fill = "cornflowerblue", 
               color = "cornflowerblue") +
  
scale_x_continuous(breaks = pretty_breaks(n = 10)) +
xlab("monthly returns")

})

```

### Density

```{r}
renderPlot({

  portfolio_returns_tq_rebalanced_monthly <- portfolio_returns_tq_rebalanced_monthly()
  mean <- mean(portfolio_returns_tq_rebalanced_monthly$returns)
  median <- median(portfolio_returns_tq_rebalanced_monthly$returns)
  
  skew_density_plot <- portfolio_returns_tq_rebalanced_monthly %>% 
    ggplot(aes(x = returns)) +
    stat_density(geom = "line", size = 1, color = "cornflowerblue")
  
  shaded_area_data <- 
    ggplot_build(skew_density_plot)$data[[1]] %>% 
    filter(x < mean)

  skew_density_plot_shaded <- 
    skew_density_plot + 
    geom_area(data = shaded_area_data, aes(x = x, y = y), fill="pink", alpha = 0.5)
  
  median_line_data <- 
    ggplot_build(skew_density_plot)$data[[1]] %>% 
    filter(x <= median)

skew_density_plot_shaded +
  
  geom_segment(data = median_line_data, aes(x = median, y = 0, xend = median, yend = density), 
               color = "black", linetype = "dotted") +
  
  annotate(geom = "text", x = median, y = 5, label = "median", 
           fontface = "plain", angle = 90, alpha = .8, vjust =  1.75) +
  
  annotate(geom = "text", x = (mean - .03), y = .1, label = "returns < mean", 
           fontface = "plain", color = "red", alpha = .8, vjust =  -1) +
  
  ggtitle("Density Plot Illustrating Skewness")
  

  
})
```

Sharpe Ratio
==============================================

Row {data-height=800}
----------------------------------------------

### Rolling Sharpe

```{r}
renderHighchart({
  
  validate(need(input$go, "Please choose your portfolio assets, weights, rfr, rolling window and start date and click submit."))
  
  
  highchart(type = "stock") %>%
  hc_title(text = "Rolling Sharpe") %>%
  hc_add_series(portfolio_rolling_sharpe(), name = "Portfolio", color = "cornflowerblue") %>%
  hc_add_series(market_rolling_sharpe(), name = "Market", color = "green") %>%
  hc_navigator(enabled = FALSE) %>% 
  hc_scrollbar(enabled = FALSE) %>% 
  hc_exporting(enabled = TRUE) %>% 
  hc_legend(enabled = TRUE, align = "right", verticalAlign = "middle",
            layout = "vertical")

  
})
```

Row {data-height=200}
-----------------------------------------------------------------------

### The Sharpe Ratio of Your Portfolio

```{r}
renderValueBox({
  
  
  valueBox(value = tags$p(round(portfolio_sharpe(), 4), 
                          style = "font-size: 70%;"), 
           color = "primary")
})

```

### Sharpe Ratio of S&P500 in same time period

```{r}
renderValueBox({
  
  valueBox(value = tags$p(round(market_sharpe(), 4), 
                          style = "font-size: 70%;"), 
           color = "primary")
})

```


















